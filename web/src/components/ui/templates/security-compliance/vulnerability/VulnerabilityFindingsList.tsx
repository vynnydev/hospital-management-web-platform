import React, { useState } from 'react';
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from '@/components/ui/organisms/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/organisms/table';
import { Badge } from '@/components/ui/organisms/badge';
import { Button } from '@/components/ui/organisms/button';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/organisms/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/organisms/select';
import { Input } from '@/components/ui/organisms/input';
import { AlertTriangle, CheckCircle, Info, XCircle } from 'lucide-react';

interface Finding {
  id: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  category: string;
  description: string;
  affectedComponent: string;
  status: 'open' | 'in_progress' | 'fixed' | 'accepted_risk';
  remediation?: string;
  fixDueDate?: string;
  assignedTo?: string;
}

interface VulnerabilityFindingsListProps {
  findings: Finding[];
}

export const VulnerabilityFindingsList: React.FC<VulnerabilityFindingsListProps> = ({ findings }) => {
  const [selectedFinding, setSelectedFinding] = useState<Finding | null>(null);
  const [showDetailDialog, setShowDetailDialog] = useState(false);
  const [statusFilter, setStatusFilter] = useState<string>('');
  const [severityFilter, setSeverityFilter] = useState<string>('');
  const [searchQuery, setSearchQuery] = useState<string>('');

  // Apply filters to the findings
  const filteredFindings = findings.filter(finding => {
    // Apply status filter
    if (statusFilter && finding.status !== statusFilter) {
      return false;
    }
    
    // Apply severity filter
    if (severityFilter && finding.severity !== severityFilter) {
      return false;
    }
    
    // Apply search filter
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      return (
        finding.description.toLowerCase().includes(query) ||
        finding.category.toLowerCase().includes(query) ||
        finding.affectedComponent.toLowerCase().includes(query)
      );
    }
    
    return true;
  });

  // Helper to get severity badge
  const getSeverityBadge = (severity: string) => {
    switch (severity) {
      case 'critical':
        return <Badge variant="destructive" className="bg-red-500 dark:bg-red-600 hover:bg-red-600 dark:hover:bg-red-700 text-white">Crítico</Badge>;
      case 'high':
        return <Badge variant="destructive" className="bg-red-500 dark:bg-red-600 hover:bg-red-600 dark:hover:bg-red-700 text-white opacity-80">Alto</Badge>;
      case 'medium':
        return <Badge variant="warning" className="bg-yellow-500 dark:bg-yellow-600 hover:bg-yellow-600 dark:hover:bg-yellow-700 text-yellow-950 dark:text-yellow-100">Médio</Badge>;
      case 'low':
        return <Badge variant="secondary" className="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-300">Baixo</Badge>;
      default:
        return <Badge variant="outline" className="border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-300">{severity}</Badge>;
    }
  };

  // Helper to get status badge
  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'open':
        return <Badge variant="destructive" className="bg-red-500 dark:bg-red-600 hover:bg-red-600 dark:hover:bg-red-700 text-white">Aberto</Badge>;
      case 'in_progress':
        return <Badge variant="warning" className="bg-yellow-500 dark:bg-yellow-600 hover:bg-yellow-600 dark:hover:bg-yellow-700 text-yellow-950 dark:text-yellow-100">Em Progresso</Badge>;
      case 'fixed':
        return <Badge variant="success" className="bg-green-500 dark:bg-green-600 hover:bg-green-600 dark:hover:bg-green-700 text-green-950 dark:text-green-100">Corrigido</Badge>;
      case 'accepted_risk':
        return <Badge variant="outline" className="border-blue-500 dark:border-blue-400 text-blue-500 dark:text-blue-400">Risco Aceito</Badge>;
      default:
        return <Badge variant="outline" className="border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-300">{status}</Badge>;
    }
  };

  // Helper to get status icon
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'open':
        return <AlertTriangle className="h-4 w-4 text-red-500 dark:text-red-400" />;
      case 'in_progress':
        return <Info className="h-4 w-4 text-yellow-500 dark:text-yellow-400" />;
      case 'fixed':
        return <CheckCircle className="h-4 w-4 text-green-500 dark:text-green-400" />;
      case 'accepted_risk':
        return <XCircle className="h-4 w-4 text-blue-500 dark:text-blue-400" />;
      default:
        return null;
    }
  };

  const handleFindingClick = (finding: Finding) => {
    setSelectedFinding(finding);
    setShowDetailDialog(true);
  };

  return (
    <>
      <Card className="border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
        <CardHeader className="pb-2">
          <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
            <CardTitle className="text-gray-900 dark:text-white">Vulnerabilidades Encontradas</CardTitle>
            
            <div className="flex flex-wrap items-center gap-2">
              <Input
                placeholder="Pesquisar vulnerabilidades..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="max-w-[200px] bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white"
              />
              
              <Select
                value={severityFilter || undefined}
                onValueChange={setSeverityFilter}
              >
                <SelectTrigger className="w-[130px] bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white">
                  <SelectValue placeholder="Severidade" />
                </SelectTrigger>
                <SelectContent className="bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700">
                  <SelectItem value="all" className="text-gray-900 dark:text-white">Todas</SelectItem>
                  <SelectItem value="critical" className="text-gray-900 dark:text-white">Crítico</SelectItem>
                  <SelectItem value="high" className="text-gray-900 dark:text-white">Alto</SelectItem>
                  <SelectItem value="medium" className="text-gray-900 dark:text-white">Médio</SelectItem>
                  <SelectItem value="low" className="text-gray-900 dark:text-white">Baixo</SelectItem>
                </SelectContent>
              </Select>

              <Select
                value={statusFilter || undefined}
                onValueChange={setStatusFilter}
              >
                <SelectTrigger className="w-[130px] bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white">
                  <SelectValue placeholder="Status" />
                </SelectTrigger>
                <SelectContent className="bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700">
                  <SelectItem value="all" className="text-gray-900 dark:text-white">Todos</SelectItem>
                  <SelectItem value="open" className="text-gray-900 dark:text-white">Abertos</SelectItem>
                  <SelectItem value="in_progress" className="text-gray-900 dark:text-white">Em Progresso</SelectItem>
                  <SelectItem value="fixed" className="text-gray-900 dark:text-white">Corrigidos</SelectItem>
                  <SelectItem value="accepted_risk" className="text-gray-900 dark:text-white">Risco Aceito</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </CardHeader>
        
        <CardContent>
          <div className="rounded-md border border-gray-200 dark:border-gray-700">
            <Table>
              <TableHeader>
                <TableRow className="bg-gray-50 dark:bg-gray-800/50">
                  <TableHead className="text-gray-700 dark:text-gray-300">Severidade</TableHead>
                  <TableHead className="text-gray-700 dark:text-gray-300">Descrição</TableHead>
                  <TableHead className="hidden md:table-cell text-gray-700 dark:text-gray-300">Componente</TableHead>
                  <TableHead className="hidden md:table-cell text-gray-700 dark:text-gray-300">Categoria</TableHead>
                  <TableHead className="text-gray-700 dark:text-gray-300">Status</TableHead>
                  <TableHead className="text-right text-gray-700 dark:text-gray-300">Ação</TableHead>
                </TableRow>
              </TableHeader>
              
              <TableBody>
                {filteredFindings.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={6} className="h-24 text-center text-gray-500 dark:text-gray-400">
                      Nenhuma vulnerabilidade encontrada com os filtros atuais.
                    </TableCell>
                  </TableRow>
                ) : (
                  filteredFindings.map((finding) => (
                    <TableRow key={finding.id} className="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50">
                      <TableCell>
                        {getSeverityBadge(finding.severity)}
                      </TableCell>
                      <TableCell>
                        <div className="font-medium text-gray-900 dark:text-white">{finding.description}</div>
                      </TableCell>
                      <TableCell className="hidden md:table-cell text-gray-700 dark:text-gray-300">
                        {finding.affectedComponent}
                      </TableCell>
                      <TableCell className="hidden md:table-cell text-gray-700 dark:text-gray-300">
                        {finding.category}
                      </TableCell>
                      <TableCell>
                        {getStatusBadge(finding.status)}
                      </TableCell>
                      <TableCell className="text-right">
                        <Button 
                          variant="ghost" 
                          size="sm"
                          onClick={() => handleFindingClick(finding)}
                          className="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
                        >
                          Detalhes
                        </Button>
                      </TableCell>
                    </TableRow>
                  ))
                )}
              </TableBody>
            </Table>
          </div>
        </CardContent>
        
        <CardFooter className="flex justify-between">
          <div className="text-sm text-gray-500 dark:text-gray-400">
            Exibindo {filteredFindings.length} de {findings.length} vulnerabilidades
          </div>
          <Button 
            variant="outline" 
            size="sm"
            className="border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800"
          >
            Exportar Relatório
          </Button>
        </CardFooter>
      </Card>

      {/* Finding detail dialog */}
      <Dialog open={showDetailDialog} onOpenChange={setShowDetailDialog}>
        {selectedFinding && (
          <DialogContent className="max-w-2xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2 text-gray-900 dark:text-white">
                <span>Detalhes da Vulnerabilidade</span>
                {getSeverityBadge(selectedFinding.severity)}
              </DialogTitle>
              <DialogDescription className="text-gray-500 dark:text-gray-400">
                {selectedFinding.description}
              </DialogDescription>
            </DialogHeader>
            
            <div className="space-y-4 py-2">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-3">
                  <div>
                    <div className="text-sm font-medium text-gray-500 dark:text-gray-400">ID</div>
                    <div className="text-sm font-mono text-gray-900 dark:text-white">{selectedFinding.id}</div>
                  </div>
                  
                  <div>
                    <div className="text-sm font-medium text-gray-500 dark:text-gray-400">Componente Afetado</div>
                    <div className="text-sm text-gray-900 dark:text-white">{selectedFinding.affectedComponent}</div>
                  </div>
                  
                  <div>
                    <div className="text-sm font-medium text-gray-500 dark:text-gray-400">Categoria</div>
                    <div className="text-sm text-gray-900 dark:text-white">{selectedFinding.category}</div>
                  </div>
                </div>
                
                <div className="space-y-3">
                  <div>
                    <div className="text-sm font-medium text-gray-500 dark:text-gray-400">Status</div>
                    <div className="flex items-center gap-1 text-gray-900 dark:text-white">
                      {getStatusIcon(selectedFinding.status)}
                      <span className="text-sm">{
                        selectedFinding.status === 'open' ? 'Aberto' :
                        selectedFinding.status === 'in_progress' ? 'Em Progresso' :
                        selectedFinding.status === 'fixed' ? 'Corrigido' : 
                        'Risco Aceito'
                      }</span>
                    </div>
                  </div>
                  
                  {selectedFinding.assignedTo && (
                    <div>
                      <div className="text-sm font-medium text-gray-500 dark:text-gray-400">Responsável</div>
                      <div className="text-sm text-gray-900 dark:text-white">{selectedFinding.assignedTo}</div>
                    </div>
                  )}
                  
                  {selectedFinding.fixDueDate && (
                    <div>
                      <div className="text-sm font-medium text-gray-500 dark:text-gray-400">Prazo para Correção</div>
                      <div className="text-sm text-gray-900 dark:text-white">{new Date(selectedFinding.fixDueDate).toLocaleDateString()}</div>
                    </div>
                  )}
                </div>
              </div>
              
              {selectedFinding.remediation && (
                <div className="space-y-1">
                  <div className="text-sm font-medium text-gray-500 dark:text-gray-400">Remediação</div>
                  <div className="text-sm p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white">
                    {selectedFinding.remediation}
                  </div>
                </div>
              )}
              
              <div className="rounded-md border border-gray-200 dark:border-gray-700 p-4 bg-gray-50 dark:bg-gray-800">
                <div className="flex items-center mb-3">
                  <AlertTriangle className="h-5 w-5 text-yellow-500 dark:text-yellow-400 mr-2" />
                  <h4 className="text-sm font-medium text-gray-900 dark:text-white">Impacto de Segurança</h4>
                </div>
                <p className="text-sm text-gray-600 dark:text-gray-400">
                  Esta vulnerabilidade pode levar a {
                    selectedFinding.severity === 'critical' ? 'acesso não autorizado com privilégios elevados, permitindo controle total do sistema.' :
                    selectedFinding.severity === 'high' ? 'comprometimento significativo de dados ou funcionalidades críticas do sistema.' :
                    selectedFinding.severity === 'medium' ? 'acesso limitado a dados sensíveis ou interrupção parcial de funcionalidades.' :
                    'divulgação limitada de informações não críticas ou pequenas degradações de desempenho.'
                  }
                </p>
              </div>
            </div>
            
            <DialogFooter>
              {selectedFinding.status !== 'fixed' && (
                <div className="flex gap-2">
                  <Button 
                    variant="outline"
                    className="border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800"
                  >
                    Atualizar Status
                  </Button>
                  <Button 
                    variant="default"
                    className="bg-primary hover:bg-primary/90 text-white dark:bg-primary dark:hover:bg-primary/90 dark:text-white"
                  >
                    Marcar como Corrigido
                  </Button>
                </div>
              )}
              {selectedFinding.status === 'fixed' && (
                <Button 
                  variant="outline"
                  className="border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800"
                >
                  Fechar
                </Button>
              )}
            </DialogFooter>
          </DialogContent>
        )}
      </Dialog>
    </>
  );
};