/* eslint-disable @typescript-eslint/no-explicit-any */
import React, { useMemo } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/organisms/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/organisms/tabs';
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  Legend, 
  ResponsiveContainer,
  LineChart,
  Line,
  PieChart,
  Pie,
  Cell
} from 'recharts';
import { IVulnerabilityScan } from '@/types/security-compliance-types';
import { AlertTriangle, CheckCircle, LineChart as LineChartIcon } from 'lucide-react';

// Colors for charts
const COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e'];

interface VulnerabilityTrendChartProps {
  scans: IVulnerabilityScan[];
}

export const VulnerabilityTrendChart: React.FC<VulnerabilityTrendChartProps> = ({ scans }) => {
  const [chartType, setChartType] = React.useState('line');
  
  // Format and transform data for charts
  const chartData = useMemo(() => {
    // Sort scans by date
    const sortedScans = [...scans].sort((a, b) => 
      new Date(a.scanDate).getTime() - new Date(b.scanDate).getTime()
    );
    
    return sortedScans.map(scan => ({
      name: new Date(scan.scanDate).toLocaleDateString(),
      critical: scan.summary.critical,
      high: scan.summary.high,
      medium: scan.summary.medium,
      low: scan.summary.low,
      fixed: scan.summary.fixed,
      total: scan.summary.total
    }));
  }, [scans]);
  
  // Calculate latest distribution for pie chart
  const pieData = useMemo(() => {
    if (scans.length === 0) return [];
    
    // Get the latest scan
    const latestScan = [...scans].sort((a, b) => 
      new Date(b.scanDate).getTime() - new Date(a.scanDate).getTime()
    )[0];
    
    return [
      { name: 'Crítico', value: latestScan.summary.critical },
      { name: 'Alto', value: latestScan.summary.high },
      { name: 'Médio', value: latestScan.summary.medium },
      { name: 'Baixo', value: latestScan.summary.low }
    ];
  }, [scans]);
  
  // Calculate remediation trend data
  const remediationData = useMemo(() => {
    return chartData.map(item => ({
      name: item.name,
      percentFixed: item.total > 0 ? Math.round((item.fixed / item.total) * 100) : 0,
      fixed: item.fixed,
      total: item.total
    }));
  }, [chartData]);

  // Custom tooltip for charts
  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white p-3 border rounded shadow-sm">
          <p className="font-medium text-sm">{label}</p>
          <div className="space-y-1 mt-1">
            {payload.map((entry: any, index: number) => (
              <div key={index} className="flex items-center text-xs">
                <div 
                  className="w-3 h-3 mr-1" 
                  style={{ backgroundColor: entry.color }}
                ></div>
                <span className="font-medium">{entry.name}: </span>
                <span className="ml-1">{entry.value}</span>
              </div>
            ))}
          </div>
        </div>
      );
    }
    return null;
  };

  return (
    <div className="space-y-4">
      <Tabs value={chartType} onValueChange={setChartType} className="w-full">
        <TabsList className="grid w-full grid-cols-2 mb-4">
          <TabsTrigger value="line" className="flex items-center gap-2">
            <LineChartIcon size={16} />
            <span>Tendências ao Longo do Tempo</span>
          </TabsTrigger>
          <TabsTrigger value="remediation" className="flex items-center gap-2">
            <CheckCircle size={16} />
            <span>Progresso de Remediação</span>
          </TabsTrigger>
        </TabsList>
        
        <TabsContent value="line">
          <Card>
            <CardHeader>
              <CardTitle>Evolução de Vulnerabilidades</CardTitle>
              <CardDescription>
                Tendências de vulnerabilidades por severidade ao longo do tempo
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="h-80">
                {chartData.length === 0 ? (
                  <div className="flex items-center justify-center h-full text-gray-400">
                    <div className="text-center">
                      <AlertTriangle className="h-10 w-10 mx-auto mb-2" />
                      <div>Não há dados históricos suficientes para exibir tendências</div>
                    </div>
                  </div>
                ) : (
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart
                      data={chartData}
                      margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis />
                      <Tooltip content={<CustomTooltip />} />
                      <Legend />
                      <Line 
                        type="monotone" 
                        dataKey="critical" 
                        name="Crítico"
                        stroke="#ef4444" 
                        activeDot={{ r: 8 }} 
                        strokeWidth={2}
                      />
                      <Line 
                        type="monotone" 
                        dataKey="high" 
                        name="Alto"
                        stroke="#f97316" 
                        activeDot={{ r: 6 }} 
                      />
                      <Line 
                        type="monotone" 
                        dataKey="medium" 
                        name="Médio"
                        stroke="#eab308" 
                      />
                      <Line 
                        type="monotone" 
                        dataKey="low" 
                        name="Baixo"
                        stroke="#22c55e" 
                      />
                    </LineChart>
                  </ResponsiveContainer>
                )}
              </div>
              
              <div className="mt-10 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="h-72">
                  <h3 className="text-base font-medium mb-3">Distribuição Atual por Severidade</h3>
                  {pieData.length === 0 ? (
                    <div className="flex items-center justify-center h-full text-gray-400">
                      <div>Sem dados disponíveis</div>
                    </div>
                  ) : (
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={pieData}
                          cx="50%"
                          cy="50%"
                          labelLine={false}
                          label={({ name, percent }) => `${name} (${(percent * 100).toFixed(0)}%)`}
                          outerRadius={80}
                          fill="#8884d8"
                          dataKey="value"
                        >
                          {pieData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                          ))}
                        </Pie>
                        <Tooltip />
                      </PieChart>
                    </ResponsiveContainer>
                  )}
                </div>
                
                <div className="h-72">
                  <h3 className="text-base font-medium mb-3">Tendência por Scan</h3>
                  {chartData.length === 0 ? (
                    <div className="flex items-center justify-center h-full text-gray-400">
                      <div>Sem dados disponíveis</div>
                    </div>
                  ) : (
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart
                        data={chartData}
                        margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                      >
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="name" />
                        <YAxis />
                        <Tooltip content={<CustomTooltip />} />
                        <Legend />
                        <Bar dataKey="critical" name="Crítico" stackId="a" fill="#ef4444" />
                        <Bar dataKey="high" name="Alto" stackId="a" fill="#f97316" />
                        <Bar dataKey="medium" name="Médio" stackId="a" fill="#eab308" />
                        <Bar dataKey="low" name="Baixo" stackId="a" fill="#22c55e" />
                      </BarChart>
                    </ResponsiveContainer>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
        
        <TabsContent value="remediation">
          <Card>
            <CardHeader>
              <CardTitle>Progresso de Remediação</CardTitle>
              <CardDescription>
                Acompanhamento da correção de vulnerabilidades ao longo do tempo
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="h-80">
                {remediationData.length === 0 ? (
                  <div className="flex items-center justify-center h-full text-gray-400">
                    <div className="text-center">
                      <AlertTriangle className="h-10 w-10 mx-auto mb-2" />
                      <div>Não há dados históricos suficientes para exibir tendências</div>
                    </div>
                  </div>
                ) : (
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart
                      data={remediationData}
                      margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis yAxisId="left" domain={[0, 100]} />
                      <YAxis yAxisId="right" orientation="right" />
                      <Tooltip content={<CustomTooltip />} />
                      <Legend />
                      <Line 
                        yAxisId="left"
                        type="monotone" 
                        dataKey="percentFixed" 
                        name="% Resolvido"
                        stroke="#22c55e" 
                        activeDot={{ r: 8 }} 
                        strokeWidth={2}
                        unit="%"
                      />
                      <Line 
                        yAxisId="right"
                        type="monotone" 
                        dataKey="fixed" 
                        name="Corrigidos"
                        stroke="#0ea5e9" 
                      />
                      <Line 
                        yAxisId="right"
                        type="monotone" 
                        dataKey="total" 
                        name="Total"
                        stroke="#6b7280" 
                        strokeDasharray="5 5"
                      />
                    </LineChart>
                  </ResponsiveContainer>
                )}
              </div>
              
              <div className="mt-10 h-72">
                <h3 className="text-base font-medium mb-3">Tendência de Correção por Scan</h3>
                {remediationData.length === 0 ? (
                  <div className="flex items-center justify-center h-full text-gray-400">
                    <div>Sem dados disponíveis</div>
                  </div>
                ) : (
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart
                      data={remediationData}
                      margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis />
                      <Tooltip content={<CustomTooltip />} />
                      <Legend />
                      <Bar 
                        dataKey="fixed" 
                        name="Corrigidos" 
                        fill="#22c55e" 
                        stackId="a" 
                      />
                      <Bar 
                        dataKey="total" 
                        name="Pendentes" 
                        fill="#ef4444" 
                        stackId="a" 
                        // Calculate unfixed vulnerabilities
                        // formatter={(value, name, props) => {
                        //   const fixed = props.payload.fixed;
                        //   return value - fixed;
                        // }}
                      />
                    </BarChart>
                  </ResponsiveContainer>
                )}
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
};